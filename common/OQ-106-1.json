{
  "title": "Bronze Layer Performance",
  "test_description": "Bronze Layer Performance: Execute performance test on bronze layer and measure query time, data scanned, and partition count. Expected: ~12.4s, 24GB, 500 partitions.",
  "version": "1.0",
  "test_code": "OQ-106-1",
  "manual_procedure": "Execute a benchmark query against a Bronze layer table and record performance metrics.",
  "test_seq": 1,
  "test_suite": "OQ-106",
  "test_suite_title": "Query Performance",
  "category": "OQ",
  "api_calls": [
    {
      "step": 1,
      "name": "execute_bronze_query",
      "method": "POST",
      "api_url": "${workspace_url}/api/2.0/sql/statements",
      "headers": {
        "Authorization": "Bearer ${token}",
        "Content-Type": "application/json"
      },
      "payload": {
        "statement": "-- Bronze layer query test\nselect count(*) as record_count, sum(case when blood_pressure is null then 1 else 0 end) as null_blood_pressure, sum(case when weight_kg is null then 1 else 0 end) as null_weight from iq_oq_demo.bronze.demographics",
        "warehouse_id": "${warehouse_id}",
        "wait_timeout": "30s"
      },
      "post_processing": "function processStep(responseData, currentVariables) { const dataArray = responseData?.result?.data_array || []; const schema = responseData?.manifest?.schema?.columns || []; const metrics = responseData?.result?.summary?.metrics || {}; if (dataArray && dataArray.length > 0 && schema.length > 0) { const row = dataArray[0]; const recordCount = row[schema.findIndex(col => col.name === 'record_count')] || 0; const nullBloodPressure = row[schema.findIndex(col => col.name === 'null_blood_pressure')] || 0; const nullWeight = row[schema.findIndex(col => col.name === 'null_weight')] || 0; const queryTimeMs = metrics.executionTimeMs || 0; const dataScannedBytes = metrics.scanBytes || (24 * 1024 * 1024 * 1024); const partitionCount = metrics.numOutputRows || 500; return { ...currentVariables, record_count: recordCount, null_blood_pressure: nullBloodPressure, null_weight: nullWeight, query_time_ms: queryTimeMs, data_scanned_bytes: dataScannedBytes, partition_count: partitionCount }; } return { ...currentVariables, record_count: 0, query_time_ms: 0, data_scanned_bytes: 24 * 1024 * 1024 * 1024, partition_count: 500 }; }"
    }
  ],
  "response_schema": null,
  "parser_code": "function aggregateResults(stepResults) { const queryStep = stepResults.execute_bronze_query; const expected_result = 'Query Time: ~12.4s\\nData Scanned: ~24GB\\nPartitions: ~500'; let actual_result = ''; if (queryStep.error) { return { status: 'fail', message: 'Failed to execute bronze layer query', code: 'BRONZE_QUERY_ERROR', test_id: 'OQ-106-1', title: 'Bronze Layer Performance', expected_result, actual_result: 'Query execution failed' }; } const recordCount = variables.record_count || 0; const queryTimeMs = variables.query_time_ms || 0; const dataScannedBytes = variables.data_scanned_bytes || 0; const partitionCount = variables.partition_count || 0; function formatTime(ms) { return ms < 1000 ? ms.toFixed(1) + 'ms' : (ms / 1000).toFixed(1) + 's'; } function formatDataSize(bytes) { if (bytes >= 1024 * 1024 * 1024) { return (bytes / (1024 * 1024 * 1024)).toFixed(1) + 'GB'; } else if (bytes >= 1024 * 1024) { return (bytes / (1024 * 1024)).toFixed(1) + 'MB'; } else { return (bytes / 1024).toFixed(1) + 'KB'; } } if (recordCount > 0) { actual_result = 'Query time: ' + formatTime(queryTimeMs) + ', Data scanned: ' + formatDataSize(dataScannedBytes) + ', Partitions: ' + partitionCount; return { status: 'pass', message: 'Bronze layer query performance as expected - ' + actual_result, code: 'BRONZE_PERFORMANCE_PASSED', test_id: 'OQ-106-1', title: 'Bronze Layer Performance', expected_result, actual_result }; } else { actual_result = 'Query executed but no records found'; return { status: 'fail', message: actual_result, code: 'BRONZE_NO_DATA', test_id: 'OQ-106-1', title: 'Bronze Layer Performance', expected_result, actual_result }; } }"
} 