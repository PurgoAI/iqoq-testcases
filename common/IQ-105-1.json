{
  "title": "Directory Structure",
  "test_description": "Validate directory structure (bronze/silver/gold layers)",
  "version": "1.0",
  "test_code": "IQ-105-1",
  "test_seq": 1,
  "test_suite": "IQ-105",
  "test_suite_title": "Data Storage Validation",
  "category": "IQ",
  "api_calls": [
    {
      "step": 1,
      "name": "get_metastore_id",
      "method": "POST",
      "api_url": "${workspace_url}/api/2.0/sql/statements",
      "headers": {
        "Authorization": "Bearer ${token}",
        "Content-Type": "application/json"
      },
      "payload": {
        "warehouse_id": "${warehouse_id}",
        "statement": "SELECT CURRENT_METASTORE() AS active_metastore;",
        "wait_timeout": "30s"
      },
      "post_processing": "function processStep(responseData, currentVariables) { const metastoreId = responseData?.result?.data_array?.[0]?.[0]; const metastoreIdUuid = metastoreId && metastoreId.includes(':') ? metastoreId.split(':').pop() : metastoreId; return { ...currentVariables, metastore_id: metastoreId, metastore_id_uuid: metastoreIdUuid }; }"
    },
    {
      "step": 2,
      "name": "get_catalogs",
      "method": "GET",
      "api_url": "${workspace_url}/api/2.1/unity-catalog/catalogs",
      "headers": {
        "Authorization": "Bearer ${token}",
        "Content-Type": "application/json"
      },
      "payload": {},
      "post_processing": "function processStep(responseData, currentVariables) { const catalogs = responseData.catalogs || []; return { ...currentVariables, catalogs: catalogs }; }"
    },
    {
      "step": 3,
      "name": "get_schemas_sql_fallback",
      "method": "POST",
      "api_url": "${workspace_url}/api/2.0/sql/statements",
      "headers": {
        "Authorization": "Bearer ${token}",
        "Content-Type": "application/json"
      },
      "payload": {
        "warehouse_id": "${warehouse_id}",
        "statement": "SHOW SCHEMAS",
        "wait_timeout": "30s"
      },
      "post_processing": "function processStep(responseData, currentVariables) { const schemasSQL = responseData?.result?.data_array || []; return { ...currentVariables, schemas_sql: schemasSQL }; }"
    }
  ],
  "response_schema": null,
  "parser_code": "function aggregateResults(stepResults) { const metastoreStep = stepResults.get_metastore_id; const catalogsStep = stepResults.get_catalogs; const schemasStep = stepResults.get_schemas_sql_fallback; const expected_result = 'Directory Layers: bronze, silver, gold exist.'; let actual_result = 'Directory Layers: none found'; if (metastoreStep.error) { return { status: 'fail', message: 'Failed to get metastore ID', code: 'NO_METASTORE_ID', test_id: 'IQ-105-1', title: 'Directory Structure', expected_result, actual_result }; } if (catalogsStep.error) { return { status: 'fail', message: 'Failed to get catalogs', code: 'NO_CATALOGS', test_id: 'IQ-105-1', title: 'Directory Structure', expected_result, actual_result }; } if (schemasStep.error) { return { status: 'fail', message: 'Failed to get schemas', code: 'NO_SCHEMAS', test_id: 'IQ-105-1', title: 'Directory Structure', expected_result, actual_result }; } const metastoreId = metastoreStep.data?.result?.data_array?.[0]?.[0]; const schemasArray = schemasStep.data?.result?.data_array || []; if (!metastoreId) { return { status: 'fail', message: 'Could not extract metastore ID from response', code: 'METASTORE_EXTRACTION_FAILED', test_id: 'IQ-105-1', title: 'Directory Structure', expected_result, actual_result }; } if (schemasArray.length === 0) { return { status: 'fail', message: 'No schemas found', code: 'NO_SCHEMAS_FOUND', test_id: 'IQ-105-1', title: 'Directory Structure', expected_result, actual_result }; } const requiredLayers = ['bronze', 'silver', 'gold']; const foundLayers = []; for (const schemaRow of schemasArray) { if (schemaRow && schemaRow.length > 0) { const schemaName = String(schemaRow[0]).toLowerCase(); for (const layer of requiredLayers) { if (schemaName === layer && !foundLayers.includes(layer)) { foundLayers.push(layer); } } } } const missingLayers = requiredLayers.filter(layer => !foundLayers.includes(layer)); if (foundLayers.length === requiredLayers.length) { actual_result = 'Directory Layers: bronze, silver, gold exist.'; return { status: 'pass', message: 'All required layers (bronze/silver/gold) found in schemas', code: 'COMPLETE_STRUCTURE', test_id: 'IQ-105-1', title: 'Directory Structure', expected_result, actual_result }; } else if (foundLayers.length > 0) { actual_result = 'Directory Layers: missing ' + missingLayers.join(', '); return { status: 'fail', message: 'Incomplete layer structure in schemas. Missing: ' + missingLayers.join(', '), code: 'INCOMPLETE_STRUCTURE', test_id: 'IQ-105-1', title: 'Directory Structure', expected_result, actual_result }; } else { actual_result = 'Directory Layers: none found'; return { status: 'fail', message: 'No data layers (bronze/silver/gold) found in schemas', code: 'NO_LAYERS', test_id: 'IQ-105-1', title: 'Directory Structure', expected_result, actual_result }; } }",
  "manual_procedure": "Validate the directory structure using the Data Explorer UI or the Databricks CLI."
} 