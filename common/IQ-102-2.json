{
  "title": "Credential Rotation and Auditing",
  "test_description": "Validate that an invalid token is denied access and that the failed attempt is logged in the audit trail",
  "version": "1.2",
  "test_code": "IQ-102-2",
  "test_seq": 2,
  "test_suite": "IQ-102",
  "test_suite_title": "Unity Catalog Configuration",
  "category": "IQ",
  "api_calls": [
    {
      "step": 1,
      "name": "test_invalid_token",
      "method": "GET",
      "api_url": "${workspace_url}/api/2.0/unity-catalog/metastores",
      "headers": {
        "Authorization": "Bearer dapi_invalid_token_12345",
        "Content-Type": "application/json"
      },
      "payload": {},
      "post_processing": "function processStep(responseData, currentVariables) { return currentVariables; }"
    },
    {
      "step": 2,
      "name": "check_audit_log_for_failure",
      "method": "POST",
      "api_url": "${workspace_url}/api/2.0/sql/statements",
      "headers": {
        "Authorization": "Bearer ${token}",
        "Content-Type": "application/json"
      },
      "payload": {
        "warehouse_id": "${warehouse_id}",
        "statement": "SELECT request_id FROM system.access.audit WHERE service_name = 'unityCatalog' AND response.status_code = 403 AND event_time > now() - INTERVAL 2 MINUTES ORDER BY event_time DESC LIMIT 1",
        "wait_timeout": "30s"
      },
      "post_processing": "function processStep(responseData, currentVariables) { return currentVariables; }"
    }
  ],
  "response_schema": null,
  "parser_code": "function aggregateResults(stepResults) { const tokenStep = stepResults.test_invalid_token; const auditStep = stepResults.check_audit_log_for_failure; const expected_result = 'Access denied + audit log entry'; let actual_result = 'Access: Unknown, Audit: Not Found'; const accessDenied = tokenStep && (tokenStep.status === 401 || tokenStep.status === 403); const auditLogFound = auditStep && auditStep.data && auditStep.data.result && auditStep.data.result.data_array && auditStep.data.result.data_array.length > 0; if (accessDenied && auditLogFound) { actual_result = `Access Denied (status ${tokenStep.status}) + Audit entry found.`; return { status: 'pass', message: 'Invalid token was correctly rejected and the failure was logged.', code: 'TOKEN_VALIDATION_AND_AUDIT_OK', test_id: 'IQ-102-2', title: 'Credential Rotation and Auditing', expected_result, actual_result }; } else if (accessDenied && !auditLogFound) { actual_result = `Access Denied (status ${tokenStep.status}) but NO audit entry found.`; return { status: 'fail', message: 'Access was denied, but the failed API call was not found in the audit log within the time window.', code: 'MISSING_AUDIT_ENTRY', test_id: 'IQ-102-2', title: 'Credential Rotation and Auditing', expected_result, actual_result }; } else { actual_result = `Access Allowed (status ${tokenStep.status})`; return { status: 'fail', message: 'Security vulnerability: Invalid token was accepted by the API.', code: 'TOKEN_VALIDATION_FAILURE', test_id: 'IQ-102-2', title: 'Credential Rotation and Auditing', expected_result, actual_result }; } }",
  "manual_procedure": "Attempt expired token access"
}