{
  "title": "Data Lineage Validation",
  "test_description": "Validates data lineage for gold.patient_summary table including Unity Catalog lineage graph, transformation dependencies, and complete lineage path verification",
  "version": "1.0",
  "test_code": "OQ-107-1",
  "test_seq": 1,
  "test_suite": "OQ-107",
  "test_suite_title": "Data Lineage",
  "category": "OQ",
  "api_calls": [
    {
      "step": 1,
      "name": "describe_history",
      "method": "POST",
      "api_url": "${workspace_url}/api/2.0/sql/statements",
      "headers": {
        "Authorization": "Bearer ${token}",
        "Content-Type": "application/json"
      },
      "payload": {
        "statement": "DESCRIBE HISTORY iq_oq_demo.gold.patient_summary",
        "warehouse_id": "${warehouse_id}",
        "wait_timeout": "30s"
      },
      "post_processing": "function processStep(responseData, currentVariables) { return currentVariables; }"
    },
    {
      "step": 2,
      "name": "get_lineage_graph",
      "method": "GET",
      "api_url": "${workspace_url}/api/2.0/lineage-tracking/table-lineage?table_name=iq_oq_demo.gold.patient_summary&include_entity_lineage=true",
      "headers": {
        "Authorization": "Bearer ${token}",
        "Content-Type": "application/json"
      },
      "post_processing": "function processStep(responseData, currentVariables) { return currentVariables; }"
    },
    {
      "step": 3,
      "name": "validate_transformation_dependencies",
      "method": "POST",
      "api_url": "${workspace_url}/api/2.0/sql/statements",
      "headers": {
        "Authorization": "Bearer ${token}",
        "Content-Type": "application/json"
      },
      "payload": {
        "statement": "SELECT table_catalog, table_schema, table_name FROM system.information_schema.tables WHERE table_schema IN ('bronze', 'silver', 'gold') AND (table_name LIKE '%patient%' OR table_name LIKE '%demographics%' OR table_name LIKE '%sdtm_dm%')",
        "warehouse_id": "${warehouse_id}",
        "wait_timeout": "30s"
      },
      "post_processing": "function processStep(responseData, currentVariables) { return currentVariables; }"
    }
  ],
  "response_schema": null,
  "parser_code": "function aggregateResults(stepResults) { var overallStatus = 'pass'; var lineagePath = 'No lineage path available'; var validationDetails = []; var expected_result = 'Lineage graph correctly displays the path: raw/clinical \u2192 bronze.demographics \u2192 silver.sdtm_dm \u2192 gold.patient_summary.'; var actual_result = ''; var historyStep = stepResults.describe_history; var lineageStep = stepResults.get_lineage_graph; var dependenciesStep = stepResults.validate_transformation_dependencies; if (historyStep && historyStep.data && historyStep.data.status && historyStep.data.status.state === 'SUCCEEDED') { validationDetails.push('\u2713 Table history retrieved successfully'); } else if (historyStep && historyStep.data && historyStep.data.status && historyStep.data.status.error && historyStep.data.status.error.message && historyStep.data.status.error.message.indexOf('is a view') !== -1) { validationDetails.push('\u26a0 Table history skipped: Target is a view (expected for materialized views)'); } else { validationDetails.push('\u26a0 Table history unavailable (view or access issue)'); } var layerTables = { bronze: [], silver: [], gold: [] }; var lineageSuccess = false; if (lineageStep && lineageStep.data && lineageStep.data.upstreams) { validationDetails.push('\u2713 Unity Catalog lineage graph retrieved'); lineageSuccess = true; var upstreams = lineageStep.data.upstreams; for (var i = 0; i < upstreams.length; i++) { var upstream = upstreams[i]; var tableInfo = upstream.tableInfo; if (tableInfo && tableInfo.schema_name && tableInfo.name) { var schema = tableInfo.schema_name.toLowerCase(); var name = tableInfo.name; if (name.indexOf('__materialization') === -1) { if (layerTables[schema]) { var exists = false; for (var x = 0; x < layerTables[schema].length; x++) { if (layerTables[schema][x] === name) { exists = true; break; } } if (!exists) { layerTables[schema].push(name); } } } } } } else { validationDetails.push('\u2717 Failed to retrieve lineage graph'); overallStatus = 'fail'; } var dependenciesSuccess = false; if (dependenciesStep && dependenciesStep.data && dependenciesStep.data.status && dependenciesStep.data.status.state === 'SUCCEEDED') { validationDetails.push('\u2713 Transformation dependencies validated'); dependenciesSuccess = true; if (dependenciesStep.data.result && dependenciesStep.data.result.data_array) { var dependencyData = dependenciesStep.data.result.data_array; for (var m = 0; m < dependencyData.length; m++) { var row = dependencyData[m]; if (row.length >= 3) { var catalog = row[0]; var schema = row[1].toLowerCase(); var tableName = row[2]; if (tableName.indexOf('__materialization') === -1) { if (layerTables[schema]) { var tableExists = false; for (var n = 0; n < layerTables[schema].length; n++) { if (layerTables[schema][n] === tableName) { tableExists = true; break; } } if (!tableExists) { layerTables[schema].push(tableName); } } } } } } } else { validationDetails.push('\u2717 Failed to validate transformation dependencies'); overallStatus = 'fail'; } if (lineageSuccess || dependenciesSuccess) { var pathComponents = []; if (layerTables.bronze.length > 0) { for (var j = 0; j < layerTables.bronze.length; j++) { pathComponents.push('bronze.' + layerTables.bronze[j]); } } if (layerTables.silver.length > 0) { for (var k = 0; k < layerTables.silver.length; k++) { pathComponents.push('silver.' + layerTables.silver[k]); } } if (layerTables.gold.length > 0) { for (var l = 0; l < layerTables.gold.length; l++) { pathComponents.push('gold.' + layerTables.gold[l]); } } if (pathComponents.length > 0) { lineagePath = pathComponents.join(' \u2192 '); validationDetails.push('\u2713 Lineage path constructed: ' + lineagePath); if (overallStatus !== 'fail') { overallStatus = 'pass'; } } else { validationDetails.push('\u26a0 Limited lineage path available'); } } actual_result = 'Lineage path: ' + lineagePath + '\n' + validationDetails.join('; '); return { status: overallStatus, message: overallStatus === 'pass' ? 'Data lineage validation passed for gold.patient_summary' : 'Data lineage validation failed', code: overallStatus === 'pass' ? 'LINEAGE_VALIDATION_PASSED' : 'LINEAGE_VALIDATION_FAILED', test_id: 'OQ-107-1', title: 'Data Lineage Validation', expected_result: expected_result, actual_result: actual_result }; }",
  "manual_procedure": "Run DESCRIBE HISTORY gold.patient_summary. Visually inspect the table's lineage graph in Unity Catalog. Validate transformation dependencies from source to target."
} 